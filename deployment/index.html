
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://lnynhi02.github.io/stream-processing-pipeline-docs/deployment/">
      
      
      
        <link rel="next" href="..">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.9">
    
    
      
        <title>Deployment - Stream Processing Pipeline Docs</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.4af4bdda.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#new-york-city-yellow-trip-stream-processing" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Stream Processing Pipeline Docs" class="md-header__button md-logo" aria-label="Stream Processing Pipeline Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Stream Processing Pipeline Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Deployment
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7M9 21v-1h6v1a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1m3-17a5 5 0 0 0-5 5c0 2.05 1.23 3.81 3 4.58V16h4v-2.42c1.77-.77 3-2.53 3-4.58a5 5 0 0 0-5-5"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 0-7 7c0 2.38 1.19 4.47 3 5.74V17a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-2.26c1.81-1.27 3-3.36 3-5.74a7 7 0 0 0-7-7M9 21a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-1H9z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Stream Processing Pipeline Docs" class="md-nav__button md-logo" aria-label="Stream Processing Pipeline Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Stream Processing Pipeline Docs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Deployment
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Deployment
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      Overview
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#achievements" class="md-nav__link">
    <span class="md-ellipsis">
      Achievements
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#table-of-contents" class="md-nav__link">
    <span class="md-ellipsis">
      📕 Table Of Contents
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#local-setup" class="md-nav__link">
    <span class="md-ellipsis">
      ⚙️ Local Setup
    </span>
  </a>
  
    <nav class="md-nav" aria-label="⚙️ Local Setup">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dataset" class="md-nav__link">
    <span class="md-ellipsis">
      📂 Dataset
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    <span class="md-ellipsis">
      Prerequisites
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deployment" class="md-nav__link">
    <span class="md-ellipsis">
      💻 Deployment
    </span>
  </a>
  
    <nav class="md-nav" aria-label="💻 Deployment">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#postgres-setup" class="md-nav__link">
    <span class="md-ellipsis">
      Postgres Setup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kafka-setup" class="md-nav__link">
    <span class="md-ellipsis">
      Kafka Setup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spark-setup" class="md-nav__link">
    <span class="md-ellipsis">
      Spark Setup
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    <span class="md-ellipsis">
      Summary
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Document
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="https://github.com/lnynhi02/Stream-Processing-Pipeline" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    GitHub Repository
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      Overview
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#achievements" class="md-nav__link">
    <span class="md-ellipsis">
      Achievements
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#table-of-contents" class="md-nav__link">
    <span class="md-ellipsis">
      📕 Table Of Contents
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#local-setup" class="md-nav__link">
    <span class="md-ellipsis">
      ⚙️ Local Setup
    </span>
  </a>
  
    <nav class="md-nav" aria-label="⚙️ Local Setup">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dataset" class="md-nav__link">
    <span class="md-ellipsis">
      📂 Dataset
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    <span class="md-ellipsis">
      Prerequisites
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deployment" class="md-nav__link">
    <span class="md-ellipsis">
      💻 Deployment
    </span>
  </a>
  
    <nav class="md-nav" aria-label="💻 Deployment">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#postgres-setup" class="md-nav__link">
    <span class="md-ellipsis">
      Postgres Setup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kafka-setup" class="md-nav__link">
    <span class="md-ellipsis">
      Kafka Setup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spark-setup" class="md-nav__link">
    <span class="md-ellipsis">
      Spark Setup
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    <span class="md-ellipsis">
      Summary
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="new-york-city-yellow-trip-stream-processing"><strong><em>New York City Yellow Trip Stream Processing</em></strong></h1>
<p>This reference architecture shows an <strong><em>end-to-end real-time analytics pipeline</em></strong> utilizing ETL (Extract, Transform, Load) processes. The pipeline will ingest data from a source, perform necessary transformations and computations, and load it into storage for future purposes.</p>
<p><strong><em>Scenario</em></strong>: A taxi company that has collected yellow taxi trip data in New York City. The dataset includes several fields such as total_amount, dropoff_location, pickup_location, and trip_distance. There is also a lookup file containing boroughs and zones based on location_id. To analyze trip trends in real-time, the company aims to calculate the number of trips, average revenue per hour,... and detect abnormal trips as early as possible.</p>
<h2 id="overview"><strong>Overview</strong></h2>
<p>The following is the structure of the data pipeline:</p>
<p><img alt="Image" src="../img/pipeline-1.gif" /></p>
<h2 id="achievements"><strong>Achievements</strong></h2>
<ul>
<li>Detects abnormal trip durations (e.g., less than 1 minute, more than 2 hours) and identifies discrepancies between the actual and calculated amounts.</li>
<li>Calculates average revenue and trip counts per hour, categorized by payment type and borough.</li>
<li>Configures Spark session with optimized parameters, including custom shuffle partitions and broadcast joins for efficient processing.</li>
<li>Provides a dynamic dashboard for monitoring and analyzing trends each day.</li>
<li>Efficiently writes large-scale processed streaming data to PostgreSQL in near real-time.</li>
</ul>
<p>You can download the video in the <code>img/</code> folder to see the dashboard. Or you can visit this <a href="https://drive.google.com/file/d/1Tm6IZR8wEuHAIsniyg0NmjtNx_8ZFFJI/view?usp=sharing" target="_blank">link</a> to view it.</p>
<p><img alt="Dashboard" src="../img/dashboard.png" /></p>
<h2 id="table-of-contents"><strong>📕 Table Of Contents</strong></h2>
<ul>
<li><a href="#local-setup">⚙️ Local Setup</a></li>
<li><a href="#deployment">💻 Deployment</a><ul>
<li><a href="#postgres-setup">Postgres Setup</a></li>
<li><a href="#kafka-setup">Kafka Setup</a></li>
<li><a href="#spark-setup">Spark Setup</a></li>
</ul>
</li>
<li><a href="#summary">Summary</a></li>
</ul>
<p>The sequence to run the script is: <code>create_table.py</code> -&gt; <code>spark_streaming.py</code> -&gt; <code>kafka_stream.py</code></p>
<h2 id="local-setup"><strong>⚙️ Local Setup</strong></h2>
<h3 id="dataset"><strong>📂 Dataset</strong></h3>
<p>The company has shared with you 3 key datasets for this data.</p>
<details>
<summary>🚕 New York Yellow Taxi Dataset</summary>
<p>The data file is too large to push it to GitHub. Therefore, please press below to download the zip file and extract it to the <code>data/</code> folder of the project directory. Otherwise, you can place it anywhere you want.</p>
<p><li><a href="https://drive.google.com/file/d/1mT3UTHNjPHGxKTQLuipTNqGLAsXInG9R/view" target="_blank">yellow_tripdata_2024.csv</a></li></p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>VendorID</td>
<td>A code indicating the TPEP provider that provided the record. 1= Creative Mobile Technologies, LLC; 2= VeriFone Inc.</td>
</tr>
<tr>
<td>tpep_pickup_datetime</td>
<td>The date and time when the meter was engaged.</td>
</tr>
<tr>
<td>tpep_dropoff_datetime</td>
<td>The date and time when the meter was disengaged.</td>
</tr>
<tr>
<td>Passenger_count</td>
<td>The number of passengers in the vehicle. This is a driver-entered value.</td>
</tr>
<tr>
<td>Trip_distance</td>
<td>The elapsed trip distance in miles reported by the taximeter.</td>
</tr>
<tr>
<td>PULocationID</td>
<td>TLC Taxi Zone in which the taximeter was engaged.</td>
</tr>
<tr>
<td>DOLocationID</td>
<td>TLC Taxi Zone in which the taximeter was disengaged.</td>
</tr>
<tr>
<td>RateCodeID</td>
<td>The final rate code in effect at the end of the trip.<br>1= Standard rate <br>2= JFK <br>3= Newark <br>4= Nassau or Westchester <br>5= Negotiated fare <br>6= Group ride</td>
</tr>
<tr>
<td>Store_and_fwd_flag</td>
<td>Indicates whether the trip record was held in vehicle memory before sending to the vendor due to no server connection.<br>Y = Store and forward trip <br>N = Not a store and forward trip</td>
</tr>
<tr>
<td>Payment_type</td>
<td>A numeric code signifying how the passenger paid for the trip.<br>1= Credit card <br>2= Cash <br>3= No charge <br>4= Dispute <br>5= Unknown <br>6= Voided trip</td>
</tr>
<tr>
<td>Fare_amount</td>
<td>The time-and-distance fare calculated by the meter.</td>
</tr>
<tr>
<td>Extra</td>
<td>Miscellaneous extras and surcharges, including $0.50 and $1 rush hour and overnight charges.</td>
</tr>
<tr>
<td>MTA_tax</td>
<td>$0.50 MTA tax automatically triggered based on the metered rate in use.</td>
</tr>
<tr>
<td>Improvement_surcharge</td>
<td>$0.30 improvement surcharge assessed at flag drop. This began in 2015.</td>
</tr>
<tr>
<td>Tip_amount</td>
<td>Tip amount. Automatically populated for credit card tips; cash tips are not included.</td>
</tr>
<tr>
<td>Tolls_amount</td>
<td>Total amount of all tolls paid in trip.</td>
</tr>
<tr>
<td>Total_amount</td>
<td>The total amount charged to passengers. Does not include cash tips.</td>
</tr>
<tr>
<td>Congestion_Surcharge</td>
<td>Total amount collected in trip for NYS congestion surcharge.</td>
</tr>
<tr>
<td>Airport_fee</td>
<td>$1.25 for pick up only at LaGuardia and John F. Kennedy Airports.</td>
</tr>
</tbody>
</table>
</details>
<details>
<summary>🔍 Taxi Zone Lookup Table</summary>
<p>This data is used to support the development of dashboard analyses in Power BI.**
<li><a href="https://github.com/lnynhi02/Stream-Processing-Pipeline/blob/main/data/taxi_zone_lookup.csv" target="_blank">taxi_zone_lookup</a></li></p>
</details>
<details>
<summary>🗺️ Taxi Zone Shapefile</summary>
<p>This data is used to support the development of dashboard analyses in Power BI.
<li><a href="https://github.com/lnynhi02/Stream-Processing-Pipeline/tree/main/data/taxi_zones" target="_blank">taxi_zone_shapefile</a></li></p>
</details>
<h3 id="prerequisites"><strong>Prerequisites</strong></h3>
<ul>
  <li>Install <a href="https://www.docker.com/products/docker-desktop/" target="_blank">Docker</a> for running Kafka</li>
  <li>Install <a href="https://www.oracle.com/java/technologies/downloads/?er=221886" target="_blank">JDK</a></li>
  <li>Install <a href="https://spark.apache.org/downloads.html" target="_blank">Spark</a></li>
  <li>Install <a href="https://www.python.org/" target="_blank">Python</a></li>
  <li>Install <a href="https://www.postgresql.org/download/" target="_blank">PostgreSQL</a></li>
</ul>

<blockquote>
<p><strong>Apache Spark is only compatible with Java 8, Java 11, or Java 17.</strong></p>
</blockquote>
<pre><code class="language-bash"># Clone the repository
 git clone https://github.com/lnynhi02/Data-Pipeline-Project.git
</code></pre>
<p><strong>Here is the overall structure of the project:</strong></p>
<pre><code>Root Directory
|
├── data
│   ├── yellow_tripdata_2024.csv
│   ├── taxi_zone_lookup.csv
│   ├── taxi_zone_shapefile
│   └── index.txt
│
├── config
│   └── config.ini
│
├── src
│   ├── create_table.py
│   ├── kafka_stream.py
│   └── spark_streaming.py
│
├── tmp
│   ├── sql_warehouse
│   ├── local_dir
│   └── checkpoint
│       ├── abnormal_duration
│       ├── abnormal_fee
│       ├── avg_duration
│       ├── avg_revenue
│       ├── raw_data
│       └── trip_count
│
└── docker-compose.yaml
</code></pre>
<ul>
<li>The <code>config</code> directory contains a <code>config.ini</code> file that includes the configuration of your PostgreSQL database and <code>requirements.txt</code> includes all the essential packages.</li>
</ul>
<h2 id="deployment"><strong>💻 Deployment</strong></h2>
<h3 id="postgres-setup">Postgres Setup</h3>
<p>Before setting up our Spark and Airflow configurations, let’s create the Postgres database that will persist our data. I prefer using the <strong>pgAdmin 4</strong> tool for this; however, any other Postgres development platform can do the job.</p>
<p>When installing Postgres, you need to set up a password that we will need later to connect to the database from the Spark environment. <strong>You must remember the password to reconnect to the database servers.</strong> You can also leave the port at 5432.</p>
<p>To create the table and add its columns, we use a script with <strong>psycopg2</strong>, a PostgreSQL database adapter for Python. We have installed the <strong>psycopg2-binary</strong> package in the <code>requirements.txt</code> file.</p>
<p>Run the Python script with the following command:</p>
<pre><code>python src/create_table.py
</code></pre>
<h3 id="kafka-setup">Kafka Setup</h3>
<p>To avoid resending messages that have already been processed each time we run the streaming task, we define an <code>index.txt</code> file that records the number of messages sent in the latest streaming session.</p>
<p>The code for the Kafka streaming task can be found in <code>src/kafka_stream.py</code>, which involves extracting data from a CSV file, serving the data to a Kafka topic using a Kafka producer, and updating the numbers in <code>index.txt</code>.</p>
<p>Run the Kafka service defined in the <code>docker-compose.yaml</code> file:</p>
<pre><code>docker-compose up -d
</code></pre>
<p>After the services start, visit the Kafka UI at http://localhost:8800/.</p>
<p>Create a topic named <em>yellow_tripdata</em> with:</p>
<ul>
<li><em>Replication factor</em> set to 1</li>
<li><em>Partitions</em> set to 10</li>
<li><em>Data retention</em> set to a small number.</li>
</ul>
<h3 id="spark-setup">Spark Setup</h3>
<p>The goal of the Spark jobs is to consume the streaming data from the Kafka topic <strong>yellow_tripdata</strong> and then transfer it to the Postgres tables.</p>
<p>The complete code for the Spark jobs is in the <code>src/spark_streaming.py</code> file.</p>
<ul>
<li>Create the Spark Session:</li>
</ul>
<pre><code class="language-python">def create_sparksession() -&gt; SparkSession:
    spark = SparkSession.builder \
            .appName(&quot;KafkaToPostgres&quot;) \
            .config(&quot;spark.sql.shuffle.partitions&quot;, &quot;9&quot;) \
            .config(&quot;spark.sql.warehouse.dir&quot;, &quot;tmp/sql_warehouse&quot;) \
            .config(&quot;spark.local.dir&quot;, &quot;tmp/local_dir&quot;) \
            .getOrCreate()
    return spark
</code></pre>
<ul>
<li>Read Kafka stream and apply schema:</li>
</ul>
<pre><code class="language-python">def create_schema(streaming_df):
    schema = StructType([
        StructField('VendorID', StringType(), True),
        StructField('tpep_pickup_datetime', StringType(), True),
        StructField('tpep_dropoff_datetime', StringType(), True),
        StructField('passenger_count', StringType(), True),
        StructField('trip_distance', StringType(), True),
        StructField('RatecodeID', StringType(), True),
        StructField('store_and_fwd_flag', StringType(), True),
        StructField('PULocationID', StringType(), True),
        StructField('DOLocationID', StringType(), True),
        StructField('payment_type', StringType(), True),
        StructField('fare_amount', StringType(), True),
        StructField('extra', StringType(), True),
        StructField('mta_tax', StringType(), True),
        StructField('tip_amount', StringType(), True),
        StructField('tolls_amount', StringType(), True),
        StructField('improvement_surcharge', StringType(), True),
        StructField('total_amount', StringType(), True),
        StructField('congestion_surcharge', StringType(), True),
        StructField('Airport_fee', StringType(), True)
    ])
    df = streaming_df.selectExpr(&quot;CAST(value AS String)&quot;)\
        .select(from_json(col('value'), schema).alias('data'))\
        .select('data.*')
    return df
</code></pre>
<ul>
<li>Run Spark jobs:</li>
</ul>
<pre><code class="language-bash">$SPARK_HOME/bin/spark-class.cmd org.apache.spark.deploy.master.Master
$SPARK_HOME/sbin/start-master.sh
</code></pre>
<ul>
<li>Start a Spark worker:</li>
</ul>
<pre><code class="language-bash">$SPARK_HOME/bin/spark-class.cmd org.apache.spark.deploy.worker.Worker spark://HOST:PORT
$SPARK_HOME/sbin/start-slave.sh spark://HOST:PORT
</code></pre>
<ul>
<li>Submit Spark jobs:</li>
</ul>
<pre><code class="language-bash">$YOUR_PROJECT_DIRECTORY/spark-submit \
--master spark://HOST:PORT \
--num-executors 1 \
--executor-memory 5G \
--total-executor-cores 10 \
--packages org.apache.spark:spark-sql-kafka-0-10_2.12:3.5.1,org.postgresql:postgresql:42.5.4,org.apache.kafka:kafka-clients:3.7.0 \
--driver-class-path /path-to-your-jar/postgresql-x.x.x.jar \
src/spark_streaming.py
</code></pre>
<p>If there are no errors, you should see successful output in the shell.</p>
<h2 id="summary"><strong>Summary</strong></h2>
<p>Throughout this guide, we’ve thoroughly examined each component of the pipeline, setting up Kafka for data streaming, from processing data with Spark to storing it in PostgreSQL. The incorporation of Docker simplifies the Kafka setup.</p>
<p>It's important to note that while this setup is ideal for learning and small-scale projects, scaling it for production use would require additional considerations, particularly regarding security and performance optimization. Future enhancements could include integrating advanced data processing techniques,expanding the pipeline to incorporate more complex data sources.</p>
<p>Thank you very much for following along with me. If you have any questions, feel free to inbox me. I hope you enjoy working on the project. Thank you!</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.sections", "navigation.top"], "search": "../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.c8b220af.min.js"></script>
      
    
  </body>
</html>